{% extends "base.html" %}

{% block title %}–ö–Ω–∏–∂–Ω—ã–π –∫–ª—É–± - –ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h1 class="mb-4">üìö –ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥</h1>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª—É–±–∞</h5>
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h6>–í—Å–µ–≥–æ –∫–Ω–∏–≥</h6>
                            <h3 class="text-primary">{{ stats.total_books }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h6>–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</h6>
                            <h3 class="text-success">{{ stats.average_rating }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h6>–°–∞–º–∞—è —Å—Ç–∞—Ä–∞—è</h6>
                            <h5 class="text-info">{{ stats.oldest_year }}</h5>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h6>–°–∞–º–∞—è –Ω–æ–≤–∞—è</h6>
                            <h5 class="text-warning">{{ stats.newest_year }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">–ü–æ–∏—Å–∫ –∫–Ω–∏–≥</h5>
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –∞–≤—Ç–æ—Ä–∞...">
                    <button class="btn btn-primary" onclick="searchBooks()">–ù–∞–π—Ç–∏</button>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–Ω–∏–≥ -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ê–≤—Ç–æ—Ä</th>
                        <th>–ì–æ–¥</th>
                        <th>–ñ–∞–Ω—Ä</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–†–µ–π—Ç–∏–Ω–≥</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for book in books %}
                    <tr>
                        <td>{{ book.id }}</td>
                        <td><strong>{{ book.title }}</strong></td>
                        <td>{{ book.author }}</td>
                        <td>{{ book.year }}</td>
                        <td><span class="badge bg-info">{{ book.genre }}</span></td>
                        <td>
                            {% if book.status == "–í –Ω–∞–ª–∏—á–∏–∏" %}
                                <span class="badge bg-success">{{ book.status }}</span>
                            {% elif book.status == "–ß–∏—Ç–∞–µ—Ç—Å—è" %}
                                <span class="badge bg-warning">{{ book.status }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ book.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if book.rating %}
                                <span class="badge bg-primary">{{ book.rating }}/10</span>
                            {% else %}
                                <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewBook({{ book.id }})">üëÅÔ∏è</button>
                            <button class="btn btn-sm btn-warning" onclick="editBook({{ book.id }})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBook({{ book.id }})">üóëÔ∏è</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if books|length == 0 %}
        <div class="alert alert-info">
            –í –∫–ª—É–±–µ –ø–æ–∫–∞ –Ω–µ—Ç –∫–Ω–∏–≥. <a href="/books/add">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</a>
        </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <!-- –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">–°—Ç–∞—Ç—É—Å—ã –∫–Ω–∏–≥</h5>
                <canvas id="statusChart" width="300" height="300"></canvas>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ –∂–∞–Ω—Ä–æ–≤ -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∂–∞–Ω—Ä–∞–º</h5>
                <canvas id="genreChart" width="300" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–Ω–∏–≥–∏ -->
<div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–Ω–∏–≥–µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bookModalBody">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const statusData = {{ stats.status_counts|tojson }};
    const genreData = {{ stats.genre_counts|tojson }};

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    document.addEventListener('DOMContentLoaded', function() {
        // –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(statusData),
                datasets: [{
                    data: Object.values(statusData),
                    backgroundColor: ['#28a745', '#ffc107', '#6c757d']
                }]
            }
        });

        // –ì—Ä–∞—Ñ–∏–∫ –∂–∞–Ω—Ä–æ–≤
        const genreCtx = document.getElementById('genreChart').getContext('2d');
        new Chart(genreCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(genreData),
                datasets: [{
                    data: Object.values(genreData),
                    backgroundColor: ['#007bff', '#6f42c1', '#e83e8c', '#fd7e14', '#20c997']
                }]
            }
        });
    });

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–∏–≥–∞–º–∏
    function searchBooks() {
        const query = document.getElementById('searchInput').value;
        if (query) {
            window.location.href = `/api/books/search/${encodeURIComponent(query)}`;
        }
    }

    function viewBook(bookId) {
        fetch(`/api/books/${bookId}`)
            .then(response => response.json())
            .then(data => {
                const book = data.book;
                const modalBody = document.getElementById('bookModalBody');
                modalBody.innerHTML = `
                    <h6>${book.title}</h6>
                    <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${book.author}</p>
                    <p><strong>–ì–æ–¥ –∏–∑–¥–∞–Ω–∏—è:</strong> ${book.year}</p>
                    <p><strong>–ñ–∞–Ω—Ä:</strong> ${book.genre}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${book.status}</p>
                    <p><strong>–ß–∏—Ç–∞—Ç–µ–ª—å:</strong> ${book.reader || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</p>
                    <p><strong>–†–µ–π—Ç–∏–Ω–≥:</strong> ${book.rating || '–ù–µ –æ—Ü–µ–Ω–µ–Ω–∞'}</p>
                    <p><strong>–î–æ–±–∞–≤–ª–µ–Ω–∞:</strong> ${book.created_at}</p>
                    <p><strong>–û–±–Ω–æ–≤–ª–µ–Ω–∞:</strong> ${book.updated_at}</p>
                `;
                new bootstrap.Modal(document.getElementById('bookModal')).show();
            });
    }

    function editBook(bookId) {
        if (confirm('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É?')) {
            // –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
    }

    function deleteBook(bookId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É?')) {
            fetch(`/api/books/${bookId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        alert('–ö–Ω–∏–≥–∞ —É–¥–∞–ª–µ–Ω–∞!');
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–Ω–∏–≥–∏');
                    }
                });
        }
    }
</script>
{% endblock %}